# HebrewFixer Project Handoff Document

**HebrewFixer Manuscripts Series:** Appendix A (handoff; not a volume)

**Date:** 2026-02-07
**Purpose:** Complete context transfer for incoming AI assistant

---

## Project Overview

**HebrewFixer** is an AutoHotkey v2 application that enables RTL (right-to-left) Hebrew typing in applications that lack native BiDi support, specifically **Affinity Designer/Publisher/Photo**. The app runs as a system tray icon and intercepts keyboard input to handle Hebrew text entry correctly.

The core functionality is **complete and working**. We are now in the final phase: **packaging and installer polish**.

---

## The Current Problem (CRITICAL - Where You Pick Up)

We have ONE remaining blocker before shipping:

### The Tray Icon Visibility Problem

When HebrewFixer is installed and launched, its tray icon appears **in the visible taskbar area** instead of the **overflow shelf** (hidden area). We want the icon to:

1. **Appear in the overflow by default** on first run (like OBS, WireGuard, etc.)
2. **Register in the legacy "Notification Area Icons" Control Panel applet** so the user can configure it
3. **NOT flash or appear visibly during installation** if possible

### What We've Tried (All Failed or Partially Failed)

1. **Pre-creating `NotifyIconSettings` registry entries** with `IsPromoted = 0`
   - Windows 24H2 ignores pre-created entries
   - Windows doesn't even CREATE entries for new apps anymore

2. **Using `Shell_NotifyIcon` with `NIS_HIDDEN` flag**
   - API call succeeds but NO registry entry is created
   - Hidden icons don't get persisted

3. **Launching app briefly during install, setting `IsPromoted`, then closing**
   - Works but causes visible icon flicker (unacceptable)

4. **OBS source code analysis**
   - OBS does nothing special - just calls `trayIcon->show()`
   - OBS icon goes to overflow because Windows treats it as a "modern" app

### The Breakthrough Hypothesis (UNTESTED - YOUR NEXT STEP)

**EarTrumpet GitHub Issue #460** revealed that the `NOTIFYICONDATA` struct size and `uVersion` field determine how Windows treats a tray icon:

- **If `uVersion = 0` (legacy)**: Old behavior - may cause promotion
- **If `uVersion = NOTIFYICON_VERSION_4`**: Modern behavior - goes to overflow by default

**AutoHotkey may be using legacy Shell_NotifyIcon behavior**, which could explain why its icons appear promoted.

### Proposed Solution (Implement This)

1. Add `#NoTrayIcon` directive to disable AHK's built-in tray icon
2. Create custom tray icon via `DllCall` to `Shell_NotifyIcon` with:
   - Proper struct size (976 bytes for `NOTIFYICONDATAW`)
   - Call `NIM_SETVERSION` with `NOTIFYICON_VERSION_4`
   - Include `NIF_SHOWTIP` flag
3. Handle all tray menu and click events manually

---

## File Locations

### Main Project Directory
```
C:\Users\FireSongz\Desktop\HebrewFixer\
```

### Core Source Files
| File | Description |
|------|-------------|
| `src\Current Version\HebrewFixer_BiDiPaste.ahk` | Main AHK v2 script (THE source code) |
| `bin\HebrewFixer.exe` | Compiled executable |
| `bin\HebrewFixer_Setup.exe` | Inno Setup installer |

### Installer Files
| File | Description |
|------|-------------|
| `Installer\HebrewFixer_Setup.iss` | Inno Setup script |
| `Installer\PromoteTrayIcon.ps1` | PowerShell helper for tray promotion (currently unused) |

### Icons
| File | Description |
|------|-------------|
| `Icon\ICOs\hebrew_fixer_affinity_on.ico` | Main app icon (Affinity-branded) |
| `Icon\ICOs\hebrew_fixer_affinity_off.ico` | Disabled state icon |
| `Icon\ICOs\hebrew_fixer_on.ico` | Clean Shin icon (ON state) |
| `Icon\ICOs\hebrew_fixer_off.ico` | Clean Shin icon (OFF state) |

### Documentation
| File | Description |
|------|-------------|
| `.rovodev\PROJECT_MANUSCRIPT.md` | Full session history and findings |
| `.rovodev\SESSION_MANUSCRIPT_HebrewFixer.md` | Earlier session notes |
| `.rovodev\SESSION_MANUSCRIPT_HebrewFixer_20260205.md` | Previous session manuscript |
| `.rovodev\REPORT_Windows_TrayIcon_Persistence.md` | Technical report on tray persistence |
| `README.md` | GitHub README (complete) |
| `LICENSE` | MIT License |

### Experimental/Helper Scripts
| File | Description |
|------|-------------|
| `notification_area_icons_transparent.ahk` | AHK v1 script to make legacy Control Panel applet transparent |
| `enumerate_tray_windows.ahk` | Debug script to enumerate window classes |
| `window_below_mouse.ahk` | Debug script to inspect windows |

### External Resources Downloaded
| Path | Description |
|------|-------------|
| `obs-studio-source\` | OBS Studio source code (for tray icon research) |
| `obs-studio-source\obs-studio-master\frontend\widgets\OBSBasic_SysTray.cpp` | OBS tray implementation |

---

## Technical Details

### HebrewFixer Functionality (Complete)
- Physical US QWERTY â†’ Hebrew key mapping
- IME detection (activates only when Windows Hebrew keyboard is active)
- Cursor-relative RTL insertion
- Swapped Backspace/Delete behavior
- Reversed arrow keys in Hebrew mode
- BiDi-aware paste for mixed Hebrew/English
- Auto-enable mode (ON by default)
- System tray icon with context menu

### Current Installer Behavior
- Installs to `%LOCALAPPDATA%\HebrewFixer`
- Creates Start Menu, Desktop, Startup shortcuts (optional)
- Launches app after install (optional)
- Currently installs as `HebrewFixer1998.exe` (testing different name - revert to `HebrewFixer.exe`)

### Key Registry Locations (For Reference)
```
HKCU\Control Panel\NotifyIconSettings\<hash>  # Modern tray icon settings (Win10+)
HKCU\Software\Classes\Local Settings\Software\Microsoft\Windows\CurrentVersion\TrayNotify  # Legacy (deprecated)
```

### Shell_NotifyIcon Constants
```
NIM_ADD = 0x00
NIM_MODIFY = 0x01
NIM_DELETE = 0x02
NIM_SETVERSION = 0x04

NIF_MESSAGE = 0x01
NIF_ICON = 0x02
NIF_TIP = 0x04
NIF_STATE = 0x08
NIF_INFO = 0x10
NIF_GUID = 0x20
NIF_SHOWTIP = 0x80

NIS_HIDDEN = 0x01

NOTIFYICON_VERSION_4 = 4
NOTIFYICONDATA_SIZE = 976  # For NOTIFYICONDATAW on Vista+
```

---

## GitHub Repository

- **URL:** https://github.com/Cencyte/HebrewFixer (currently PRIVATE)
- **Release v1.0.0** created with binaries
- Authenticated via `gh` CLI as user `Cencyte`

---

## Key URLs / References

| Resource | URL |
|----------|-----|
| Microsoft Shell_NotifyIcon docs | https://learn.microsoft.com/en-us/windows/win32/shell/notification-area |
| NOTIFYICONDATA structure | https://learn.microsoft.com/en-us/windows/win32/api/shellapi/ns-shellapi-notifyicondataa |
| EarTrumpet Issue #460 (CRITICAL) | https://github.com/File-New-Project/EarTrumpet/issues/460 |
| Hidden icon blog post | https://blog.differentpla.net/blog/2007/10/01/shell_notifyicon-displaying-a-balloon-from-a-hidden-notification-icon/ |
| Legacy Notification Area Icons | `shell:::{05d7b0f4-2121-4eff-bf6b-ed3f69b894d9}` |

---

## User Context

- **Client:** Sara (needs Hebrew typography in Affinity Designer)
- **Developer:** FireSongz (GitHub: Cencyte)
- **Target OS:** Windows 10/11 (specifically tested on Windows 11 24H2 Build 26100)

---

## Immediate Next Steps

1. **Implement custom tray icon creation** in `HebrewFixer_BiDiPaste.ahk`:
   - Add `#NoTrayIcon` at the top
   - Replace `SetupTray()` with custom `Shell_NotifyIcon` DllCall
   - Use `NIM_SETVERSION` with `NOTIFYICON_VERSION_4`
   - Test if icon now appears in overflow by default

2. **If that works:**
   - Revert installer to use `HebrewFixer.exe` (not 1998)
   - Re-enable `SetupIconFile` in Inno Setup script
   - Rebuild and test full installation flow
   - Update GitHub release

3. **If that doesn't work:**
   - Fall back to documenting manual tray pinning in PDF guide
   - Remove "Always show in tray" option from installer entirely

---

## Compilation Commands

### Compile AHK to EXE
```powershell
& "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe" `
    /in "C:\Users\FireSongz\Desktop\HebrewFixer\src\Current Version\HebrewFixer_BiDiPaste.ahk" `
    /out "C:\Users\FireSongz\Desktop\HebrewFixer\bin\HebrewFixer.exe" `
    /icon "C:\Users\FireSongz\Desktop\HebrewFixer\Icon\ICOs\hebrew_fixer_affinity_on.ico" `
    /base "C:\Program Files\AutoHotkey\v2\AutoHotkey64.exe"
```

### Compile Installer
```powershell
Push-Location "C:\Users\FireSongz\Desktop\HebrewFixer\Installer"
& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "HebrewFixer_Setup.iss"
Pop-Location
```

---

## Final Notes

This project is 95% complete. The Hebrew input functionality works flawlessly. The only remaining issue is cosmetic/UX: making the tray icon appear in the overflow by default so users don't have to manually configure it.

The `NOTIFYICON_VERSION_4` hypothesis is the most promising lead. If it works, we ship. If it doesn't, we document the manual step and ship anyway.

---

## CRITICAL UPDATE: All Technical Approaches Failed

### Additional Testing Performed (2026-02-07)

We created a minimal C++ test program that uses `Shell_NotifyIcon` directly with:
- Proper struct size (976 bytes)
- `NOTIFYICON_VERSION_4` via `NIM_SETVERSION`
- `NIF_SHOWTIP` flag

**Result:** Icon STILL appeared in visible taskbar, not overflow.

We then **digitally signed** the executable with a self-signed certificate.

**Result:** No change. Icon still appeared in visible taskbar.

### Files Created for Testing
- `test_tray_cpp\test_tray.cpp` - Minimal C++ tray icon program
- `test_tray_cpp\TestTray_Cpp.exe` - Unsigned version
- `test_tray_cpp\TestTray_Cpp_Signed.exe` - Signed version
- `test_tray_cpp\test_cert.pfx` - Self-signed certificate (password: test123)
- `test_tray_icon.ahk` - AHK v2 test script
- `bin\TestTrayIcon_20260207_092239.exe` - Compiled AHK test

### Conclusions

1. **Windows 11 24H2 has changed default behavior** - New tray icons now appear in visible taskbar by default, contradicting Microsoft's own documentation

2. **It's NOT AutoHotkey-specific** - Pure C++ with proper Win32 API calls behaves the same

3. **Code signing makes no difference**

4. **`NOTIFYICON_VERSION_4` makes no difference**

5. **OBS/WireGuard likely have stored user preferences** from before Windows 24H2, or from their installers running some configuration we haven't identified

### Remaining Options

1. **UI Automation** - Programmatically open legacy Notification Area Icons applet (`shell:::{05d7b0f4-2121-4eff-bf6b-ed3f69b894d9}`) and automate clicking the dropdown to set "Only show notifications"

2. **Accept the limitation** - Document manual tray configuration in user guide

3. **Further research** - Find someone who has solved this on Windows 11 24H2

---

Good luck. You've got this.

---

*"I am Justice."* - Light Yagami, upon regaining his memories
